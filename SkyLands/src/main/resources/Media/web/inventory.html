<html>
	<head>
		<link rel="stylesheet" type="text/css" href="inventory.css"/>
		<script type="text/javascript" src="jquery.js"> </script>
		<script type="text/javascript" src="jqueryUI/js/jquery-ui-1.9.2.custom.min.js"></script>

		<script type="text/javascript">
			var imgHeight = 16, imgWidth = 16;

			var RatioX = 1, RatioTotalX = 1;
			var RatioY = 1, RatioTotalY = 1;

			var Selected, Position, Clone, SelectedPos;

			
			
			function clamp(val, min, max){

            	if      (val < min) { return min; }
            	else if (val > max) { return max; }
            	else                { return val; }
        	}

			function resize(ratioX, ratioY) {
				RatioX = ratioX; RatioY = ratioY;
				RatioTotalX *= ratioX; RatioTotalY *= ratioY;

				var height = document.getElementById("selectBar").offsetHeight;

				$("#selectBar").attr("width", document.getElementById("selectBar").offsetWidth * ratioX + "px");
				$("#selectBar").attr("height", height * ratioY + "px");

				$(".slot").css("font-size",  0.3 * (RatioTotalY + RatioTotalX) / 2 + "em");
				$(".num").each(function(index) {
					if($(this).html().Length == 2) {
						$(this).css("left", 10 * RatioX + "px");
					} else {
						$(this).css("left", 13 * RatioX + "px");
					}
				});
				$(".num").css("top", 10 * RatioY + "px");

				$(".slot").each(function(index) {

					if(index >= 40) {
						var row = Math.floor((index - 40) / 3);
						var col = index % 3;

						var top, left;
						if(row == 3) {
							top  = (20 + 18) * RatioTotalY;
							left =  134 * RatioTotalX;
						} else {
							top  = (20 + 18 * row) * RatioTotalY;
							left = (40 + 18 * col) * RatioTotalX;
						}

						$(this).children().attr("src", "../materials/textures/fire.png");

						$(this).attr("width",  imgWidth  * RatioTotalX + "px");
						$(this).attr("height", imgHeight * RatioTotalY + "px");

						$(this).children("img").attr("width",  imgWidth  * RatioTotalX + "px");
						$(this).children("img").attr("height", imgHeight * RatioTotalY + "px");

						$(this).css("top",  top  + "px");
						$(this).css("left", left + "px");




					} else {
						var row = Math.floor(index / 10);
						var col = index % 10;

						var top;
						if(row == 3) {
							top  = 150 * RatioTotalY;
						} else {
							top  = (92 + 18 * row) * RatioTotalY;
						}

						var left = (8  + 18 * col) * RatioTotalX;

						$(this).css("top",  top  + "px");
						$(this).css("left", left + "px");

						$(this).children("img").attr("src", "../materials/textures/fire.png");

						$(this).attr("width",  imgWidth  * RatioTotalX + "px");
						$(this).attr("height", imgHeight * RatioTotalY + "px");

						$(this).children("img").attr("width",  imgWidth  * RatioTotalX + "px");
						$(this).children("img").attr("height", imgHeight * RatioTotalY + "px");
					}

				});
			}
			
			$(window).load(function() {
				resize(1, 1);
				$(".item").draggable({
					containment: "#containor",
					scroll: false,
					cursor: "crosshair", cursorAt: { top: 8, left: 8 },
					start: function() {
						Selected = $(this);
						Position = Selected.index(".item");

						Clone = Selected.parent().clone().insertBefore(Selected.parent());
						Clone.children("img").attr("src", "../images/blank.png");
						Clone.children("span").html("");
						Selected.parent().appendTo("#containor");
						Selected.next().css("display", "none");
					},
					drag:  function(e, ui) {
						if(Selected != null) { Selected.css("opacity", "1"); Selected = null; $(".slot").css("opacity", 1); }

						console.log("x :", e.clientX, "y :", e.clientY);
						//in inventory's 3 first rows
						if(e.clientY >= 92 * RatioTotalY && e.clientY <= 143 * RatioTotalY && e.clientX >= 16 * RatioTotalX && e.clientX <= 188 * RatioTotalX) {
							var row = Math.floor((e.clientY - 91 * RatioTotalY) / 18);
							var col = clamp(Math.floor((e.clientX - 7 * RatioTotalX) / 16), 1, 10);

							console.log("row :", row, "col :", col);

							var pos = row * 10 + col - 1;
							pos = pos < 0  ? 0  : pos;
							pos = pos > 29 ? 29 : pos;

							SelectedPos = pos;

							Selected = $(".slot:eq(" + (pos) + ")");

							Selected.css("opacity", "0.5");
						} else if(e.clientY >= 150 * RatioTotalY && e.clientY <= 164 * RatioTotalY && e.clientX >= 16 * RatioTotalX && e.clientX <= 188 * RatioTotalX) {
							var col = clamp(Math.floor((e.clientX - 7 * RatioTotalX) / 16), 1, 10);

							SelectedPos = (3 * 10 + col - 1);

							Selected = $(".slot:eq(" + (3 * 10 + col - 1) + ")");
							Selected.css("opacity", "0.5");
						}
					},
					stop: function(e, ui) {

						Clone.remove();
						$(this).parent().insertBefore($(".slot:eq(" + Position + ")"));

						$(this).next().css("display", "block");
						if(Selected != null && SelectedPos != Position) {
							console.log(SelectedPos);
							console.log(Position);
							console.log(Selected);
							console.log($(".slot:eq(" + SelectedPos + ")"));
							Selected.css("opacity", "1");


							if(Selected.children("img").attr("src") == $(this).attr("src") && $(this).attr("src") != "") {
								var thisAmount = parseInt($(this) .next().html());
								var thatAmount = parseInt(Selected.children("span").html());

								if(thisAmount + thatAmount > 64) {
									setNumber(Selected.index(".slot"), 64);
									setNumber(Position, (thisAmount + thatAmount) % 64);
								} else {
									$(this).attr("src", "../images/blank.png");
									setNumber(Position, 0);
									setNumber(Selected.index(".slot"), thisAmount + thatAmount);
								}
							} else if(Selected.children("img").attr("src") == "../images/blank.png") {
								Selected.children("img").attr("src", $(this).attr("src"));
								setNumber(Selected.index(".slot"), $(this).next().html());

								$(this).attr("src", "../images/blank.png");
								setNumber(Position, 0);
							} else {
								var selectedItem = Selected.children("img").attr("src");
								var selectedItemAmount = Selected.children("span").html();

								Selected.children("img").attr("src", $(this).attr("src"));
								$(this).attr("src", selectedItem);

								Selected.children("span").html($(this) .next().html());
								$(this) .next().html(selectedItemAmount);
							}
						}

						$(this).css("top", "0px");
						$(this).css("left", "0px");

					},
					revert: function () {
						return (Selected == null);
					}

				});

			});

			function setNumber(at, amount) {
				if(amount <= 0) {
					$(".item:eq(" + at + ")").attr("src", "../images/blank.png");
					$(".item:eq(" + at + ")").next().html("");
				} else {
					$(".num:eq(" + at + ")").html(amount);
					if(amount < 10) {
						$(".num:eq(" + at + ")").css("left", 13 * RatioTotalX);
					} else {
						if(amount > 64) { $(".num:eq(" + at + ")").html(64); }
						$(".num:eq(" + at + ")").css("left", 10 * RatioTotalX);
					}
				}

			}
		</script>

	</head>
	<body>
		<div id="containor">
			<img src="../images/Inventory.png" id="selectBar" style="position: relative; z-index: -1;"/>

			<div class="slot"><img src="../materials/textures/fire.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<!-- First row done -->

			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<!-- Second row done -->

			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<!-- third row done -->

			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<div class="slot"><img src="../images/blank.png" class="item"/><span class="num">3</span></div>
			<!-- Fourth row done -->


			<!-- Crafting Grid -->
			<div class="slot"><img src="../images/blank.png" class="item"/></div>
			<div class="slot"><img src="../images/blank.png" class="item"/></div>
			<div class="slot"><img src="../images/blank.png" class="item"/></div>
			<div class="slot"><img src="../images/blank.png" class="item"/></div>
			<div class="slot"><img src="../images/blank.png" class="item"/></div>
			<div class="slot"><img src="../images/blank.png" class="item"/></div>
			<div class="slot"><img src="../images/blank.png" class="item"/></div>
			<div class="slot"><img src="../images/blank.png" class="item"/></div>
			<div class="slot"><img src="../images/blank.png" class="item"/></div>
			<div class="slot"><img src="../images/blank.png" class="item"/></div><!-- result slot -->
		</div>
	</body>
</html>